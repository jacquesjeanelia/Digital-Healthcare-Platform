"use strict";(()=>{var e={};e.id=673,e.ids=[673],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1690:(e,t,n)=>{n.r(t),n.d(t,{config:()=>p,default:()=>d,routeModule:()=>u});var a={};n.r(a),n.d(a,{default:()=>handler});var s=n(1802),o=n(7153),i=n(6249),r=n(4149),l=n(2793),c=n(4808);async function handler(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});let{id:n}=e.query;if(!n||"string"!=typeof n)return t.status(400).json({message:"Invalid appointment ID"});try{await (0,r.Z)();let a=await (0,c.W)(e,t);if(!a)return;let{userId:s,role:o}=a,{cancellationReason:i}=e.body,d=await l.Z.findById(n);if(!d)return t.status(404).json({message:"Appointment not found"});if("patient"===o&&d.patientId.toString()!==s||"doctor"===o&&d.doctorId.toString()!==s)return t.status(403).json({message:"You do not have permission to cancel this appointment"});if("cancelled"===d.status)return t.status(400).json({message:"This appointment is already cancelled"});if("completed"===d.status)return t.status(400).json({message:"Cannot cancel a completed appointment"});if("in-progress"===d.status&&"doctor"!==o&&"admin"!==o)return t.status(403).json({message:"Patients cannot cancel an in-progress appointment"});let p=new Date(d.dateTime).getTime(),u=new Date().getTime(),m=0,g="";"patient"===o&&(p-u)/36e5<24&&(m=25,g="Late cancellation fee applied (less than 24 hours notice).");let f=await l.Z.findByIdAndUpdate(n,{status:"cancelled",notes:d.notes?`${d.notes}

Cancellation: ${i||"No reason provided"}`:`Cancellation: ${i||"No reason provided"}`,updatedAt:new Date,cancellationDetails:{cancelledBy:o,cancelledById:s,cancellationTime:new Date,cancellationReason:i||"No reason provided",cancellationFee:m,cancellationNotes:g}},{new:!0});return t.status(200).json({message:"Appointment cancelled successfully",appointment:f,cancellationFee:m>0?`$${m}`:"None"})}catch(e){return console.error("Error cancelling appointment:",e),t.status(500).json({message:"Failed to cancel appointment",error:e.message})}}let d=(0,i.l)(a,"default"),p=(0,i.l)(a,"config"),u=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/appointments/cancel/[id]",pathname:"/api/appointments/cancel/[id]",bundlePath:"",filename:""},userland:a})}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),n=t.X(0,[222,149,793,808],()=>__webpack_exec__(1690));module.exports=n})();